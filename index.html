<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>North Slope Shift Calendar</title>
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <style>
    :root { --on-color:#3498db; --travel-color:#e67e22; --off-color:#ffffff; --text-main:#333; --bg-body:#f0f2f5; --bg-card:#ffffff; --border-color:#eee; --border-strong:#000; --on-tint-soft: rgba(52,152,219,0.12); --travel-tint-soft: rgba(230,126,34,0.14); --on-tint-strong: rgba(52,152,219,0.16); --travel-tint-strong: rgba(230,126,34,0.18); }
    body.dark-mode { --off-color:#2c3e50; --text-main:#ecf0f1; --bg-body:#1a1a1a; --bg-card:#2d2d2d; --border-color:#444; --border-strong:#e6e6e6; }
    body { font-family:'Segoe UI',system-ui,sans-serif; padding:20px; background:var(--bg-body); color:var(--text-main); margin:0; transition:background .3s,color .3s; }

    .header-container { display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:16px; margin-bottom:10px; }
    #pageTitle { justify-self:start; margin:0; font-size:1.5rem; font-weight:800; }
    .legend { justify-self:end; display:flex; gap:15px; background:var(--bg-card); padding:10px 15px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.1); font-size:1rem; font-weight:700; }
    .legend-item{ display:flex; align-items:center; gap:6px; }
    .dot{ width:12px; height:12px; border-radius:50%; border:2px solid var(--border-strong); }

    #nameInlineWrap{ justify-self:center; }
    .name-chip{ display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:10px; background:linear-gradient(135deg,var(--on-color),var(--travel-color)); color:#fff; font-weight:800; letter-spacing:.2px; box-shadow:0 4px 14px rgba(0,0,0,.12); font-size:1.05rem; }
    .name-chip .label{ opacity:.9; font-weight:700; font-size:.95rem; }
    .name-chip .value{ font-size:1.1rem; }
    #nameInline{ display:none; }

    .controls{ background:var(--bg-card); padding:14px; border-radius:12px; gap:10px; row-gap:10px; box-shadow:0 4px 12px rgba(0,0,0,.1); align-items:end; display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); }
    .control-group{ display:flex; flex-direction:column; gap:2px; }
    label{ font-weight:700; font-size:.85em; color:var(--text-main); opacity:.9; }
    input,select{ padding:6px 8px; border:1px solid var(--border-color); border-radius:5px; width:170px; max-width:42vw; background:var(--bg-card); color:var(--text-main); font-size:.95rem; }
    input[type=range]{ width:180px; }
    .btn{ padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:800; border:none; transition:.2s; font-size:.95rem; }
    .btn-gen{ background:#2ecc71; color:#fff; } .btn-dark{ background:#34495e; color:#fff; }

    .calendar-grid{ display:grid; gap:22px; --month-min:340px; }
    .layout-standard{ --month-min:360px; grid-template-columns:repeat(auto-fit,minmax(var(--month-min),1fr)); gap:22px; }
    .layout-compact{  --month-min:340px; grid-template-columns:repeat(auto-fit,minmax(var(--month-min),1fr)); gap:16px; }
    .layout-poster{   --month-min:380px; grid-template-columns:repeat(auto-fit,minmax(var(--month-min),1fr)); gap:26px; }
    .layout-grid{     --month-min:360px; grid-template-columns:repeat(auto-fit,minmax(var(--month-min),1fr)); gap:20px; }
    .layout-wall{     --month-min:360px; grid-template-columns:repeat(auto-fit,minmax(var(--month-min),1fr)); gap:20px; }

    #calendar-scale-wrapper{ --calendar-design-width:1600px; width:100%; display:flex; justify-content:center; overflow:visible; margin-top:6px; }
    #calendar-scale-wrapper > #calendar{ max-width:var(--calendar-design-width); }

    .month{ background:var(--bg-card); border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); padding:18px; border:2px solid var(--border-strong); }
    h3{ text-align:center; color:var(--on-color); border-bottom:2px solid var(--border-strong); padding-bottom:10px; margin-top:0; font-size:1.25rem; font-weight:800; }

    .weekday-header,.days{ display:grid; grid-template-columns:repeat(7,1fr); text-align:center; }
    .weekday-header{ font-weight:800; color:#666; font-size:.95em; margin-bottom:10px; }
    .day{ aspect-ratio:1; display:flex; align-items:center; justify-content:center; border-radius:8px; font-size:1.05em; border:2px solid var(--border-strong); font-weight:700; }

    .on-shift{   background:var(--on-color)!important; color:#fff; }
    .travel-day{ background:var(--travel-color)!important; color:#fff; }
    .off-day{    background:var(--off-color); color:var(--text-main); }
    .today{      outline:3px solid #e74c3c; outline-offset:-3px; }
    .empty{ visibility:hidden; }
    input[type=color]{ padding:0; height:38px; cursor:pointer; }

    /* THEMES */
    .theme-standard .month { border:2px solid var(--border-strong); box-shadow:0 3px 10px rgba(0,0,0,.08); }
    .theme-standard h3 { color: var(--on-color); }
    .theme-standard .weekday-header { color:#5b6b7c; }
    .theme-standard .day { border-radius:999px; background:#f6f9ff; }
    .theme-standard .off-day { background:#f2f6fb; color:#222; }
    .theme-standard .on-shift { background:var(--on-color)!important; color:#fff; border-color:var(--on-color); }
    .theme-standard .travel-day { background:var(--travel-color)!important; color:#fff; border-color:var(--travel-color); }

    .theme-aurora .month { border:2px solid var(--border-strong); border-radius:16px; background: radial-gradient(1200px 600px at -10% -20%, rgba(52,152,219,.12), transparent 60%), radial-gradient(1000px 500px at 120% 10%, rgba(230,126,34,.12), transparent 55%), #ffffff; box-shadow:0 14px 32px rgba(0,0,0,.12); overflow:hidden; }
    .theme-aurora h3 { color:#fff; text-transform:uppercase; letter-spacing:.12em; font-weight:900; margin:-18px -18px 14px -18px; padding:16px 14px; background:linear-gradient(135deg, var(--on-color), var(--travel-color)); border:none; font-size:1.25rem; text-shadow:0 1px 0 rgba(0,0,0,.25); }
    .theme-aurora .weekday-header { background: linear-gradient(90deg, rgba(0,0,0,.03), rgba(0,0,0,0)); color:#2c3e50; font-weight:900; letter-spacing:.04em; border:1px solid rgba(0,0,0,.12); border-left:none; border-right:none; }
    .theme-aurora .day { border-radius:10px; background:#f9fbff; position:relative; overflow:hidden; }
    .theme-aurora .day::after { content:""; position:absolute; inset:0; pointer-events:none; background-image: repeating-linear-gradient(45deg, rgba(255,255,255,.4) 0 6px, rgba(255,255,255,0) 6px 12px); mix-blend-mode: overlay; }
    .theme-aurora .off-day { background:#f3f6fb; color:#213042; }
    .theme-aurora .on-shift { background: linear-gradient(135deg, rgba(52,152,219,0.85), var(--on-color)); color:#fff; border-color: var(--on-color); text-shadow:0 1px 0 rgba(0,0,0,.25); }
    .theme-aurora .travel-day { background: linear-gradient(135deg, rgba(230,126,34,0.85), var(--travel-color)); color:#fff; border-color: var(--travel-color); text-shadow:0 1px 0 rgba(0,0,0,.25); }

    .theme-clean-grid .month { border:2px solid #000; box-shadow:none; background:#fff; }
    .theme-clean-grid h3 { color:#111; background:#f1f3f5; border:none; padding:12px; border-radius:6px; }
    .theme-clean-grid .weekday-header { background:#f6f7f8; color:#333; border:1px solid #000; border-left:none; border-right:none; }
    .theme-clean-grid .day { border-radius:0; background:#fff; border-color:#000; }
    .theme-clean-grid .on-shift { background: var(--on-tint-soft) !important; color:#0b3e69; border-color:#000 !important; }
    .theme-clean-grid .travel-day { background: var(--travel-tint-soft) !important; color:#6a350a; border-color:#000 !important; }

    .theme-wall .month { border:2px solid #000; border-radius:10px; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.06); }
    .theme-wall h3 { text-transform:uppercase; letter-spacing:.05em; color:#fff; margin:-18px -18px 12px -18px; padding:14px 12px; background:var(--on-color); border:none; }
    .theme-wall .weekday-header { color:#222; font-weight:900; letter-spacing:.02em; }
    .theme-wall .day { border-radius:0; justify-content:flex-end; align-items:flex-start; padding:6px 8px; background:#fff; border-color:#000; }
    .theme-wall .off-day { background:#fff; color:#222; }
    .theme-wall .on-shift { background: var(--on-tint-strong) !important; color:#0b3e69; border-color:#000 !important; }
    .theme-wall .travel-day { background: var(--travel-tint-strong) !important; color:#6a350a; border-color:#000 !important; }

    .theme-poster .month { border:3px solid #111; border-radius:4px; background:#fff; box-shadow:none; }
    .theme-poster h3 { color:#111; text-transform:uppercase; letter-spacing:.08em; border:none; padding:6px 0 10px; }
    .theme-poster .day { border-radius:6px; }

    /* PDF-only compact overrides (clone only) */
    .pdf-mode #pageTitle{ font-size:1.25rem!important; }
    .pdf-mode .legend{ padding:6px 8px!important; gap:8px!important; font-size:.9rem!important; box-shadow:none!important; }
    .pdf-mode .calendar-grid{ grid-template-columns:repeat(3,1fr)!important; gap:8px!important; --month-min:240px!important; }
    .pdf-mode .month{ padding:10px!important; }
    .pdf-mode h3{ padding-bottom:6px!important; font-size:1.15rem!important; border-width:1px!important; }
    .pdf-mode .weekday-header{ margin-bottom:6px!important; }
    .pdf-mode .day{ border-width:1px!important; }

    /* Mobile quick toolbar + Controls toggle */
    .mini-toolbar{ position:sticky; top:6px; z-index:5; display:none; gap:8px; padding:6px; margin:6px 0 8px; background:rgba(255,255,255,.9); backdrop-filter: blur(4px); border:1px solid var(--border-color); border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.08); }
    .mini-btn{ padding:8px 10px; font-weight:800; border:none; border-radius:6px; background:#e9ecef; color:#222; }
    .mini-btn:nth-child(1){ background:#2ecc71; color:#fff; }
    .mini-btn:nth-child(2){ background:#2d6cdf; color:#fff; }
    .mini-btn:nth-child(3){ background:#3498db; color:#fff; }

    .controls-toggle { display:none; margin:8px 0 10px; padding:10px 12px; font-weight:800; border:1px solid var(--border-color); border-radius:8px; background:#fff; color:var(--text-main); box-shadow:0 2px 6px rgba(0,0,0,.06); }

    @media (max-width:700px){
      .mini-toolbar{ display:flex; }
      .controls-toggle{ display:inline-block; }
      .controls.is-collapsed { display:none !important; }
      .controls { margin-top:6px; padding:10px; gap:8px; row-gap:8px; grid-template-columns:1fr; }
      .controls label { font-size:.8em; }
      .controls input, .controls select { width:100%; max-width:100%; }
      .controls .btn { width:100%; }
    }

    @media print{ @page{ size:auto; margin:0.25in; } }
  </style>
</head>
<body>
  <div id="calendar-capture-root">
    <div class="header-container">
      <h2 id="pageTitle">North Slope Shift Calendar</h2>
      <div id="nameInlineWrap"><div id="nameInline" class="name-chip"><span class="label">Name:</span><span class="value" id="nameInlineText"></span></div></div>
      <div class="legend">
        <div class="legend-item"><div class="dot" style="background:var(--on-color);"></div> Work</div>
        <div class="legend-item"><div class="dot" style="background:var(--travel-color);"></div> Travel</div>
        <div class="legend-item"><div class="dot" style="background:var(--off-color);"></div> Off</div>
      </div>
    </div>

    <!-- Mobile quick actions -->
    <div class="mini-toolbar" role="toolbar" aria-label="Quick actions">
      <button type="button" class="mini-btn" onclick="generateCalendar()">Update</button>
      <button type="button" class="mini-btn" onclick="downloadCalendarPDF()">PDF</button>
      <button type="button" class="mini-btn" onclick="downloadCalendar()">Image</button>
    </div>

    <!-- Mobile controls toggle -->
    <button type="button" id="controlsToggle" class="controls-toggle" aria-expanded="false">Show Controls</button>

    <div class="controls">
      <div class="control-group"><label for="yearSelect">Year</label><input type="number" id="yearSelect" min="1970" max="2100" value="2026" oninput="handleYearChange()"></div>
      <div class="control-group"><label for="daysOn">Days ON</label><input type="number" id="daysOn" min="1" step="1" value="21"></div>
      <div class="control-group"><label for="daysOff">Days OFF</label><input type="number" id="daysOff" min="1" step="1" value="21"></div>
      <div class="control-group"><label for="startDate">1st Day ON</label><input type="date" id="startDate" value="2026-01-08"></div>
      <div class="control-group"><label for="layoutStyle">Style</label>
        <select id="layoutStyle" onchange="generateCalendar()">
          <option value="layout-wall theme-wall">Wall Calendar</option>
          <option value="layout-grid theme-clean-grid">Clean Grid</option>
          <option value="layout-poster theme-poster">Poster Board</option>
          <option value="layout-compact theme-aurora">Aurora Mosaic</option>
          <option value="layout-standard theme-standard">Classic Cards</option>
        </select>
      </div>
      <div class="control-group"><label for="workColor">Work</label><input type="color" id="workColor" value="#3498db" oninput="updateColors(); saveSettings()" aria-label="Work color"></div>
      <div class="control-group"><label for="travelColor">Travel</label><input type="color" id="travelColor" value="#e67e22" oninput="updateColors(); saveSettings()" aria-label="Travel color"></div>
      <div class="control-group"><label for="tintStrength">Tint strength</label>
        <input type="range" id="tintStrength" min="8" max="30" step="1" value="16" oninput="updateColors(); saveSettings();">
        <small style="opacity:.7">Adjusts fill intensity for Clean Grid & Wall Calendar</small>
      </div>
      <div class="control-group"><label for="nameField">Name (optional)</label><input type="text" id="nameField" placeholder="e.g., Turd Ferguson" oninput="handleNameInput(); saveSettings()" maxlength="80"></div>
      <button type="button" class="btn btn-gen" onclick="generateCalendar()">Update</button>
      <button type="button" class="btn btn-dark" onclick="toggleDarkMode()">Dark Mode</button>
      <button type="button" class="btn" style="background:#2d6cdf;color:#fff;" onclick="downloadCalendarPDF()">Download PDF</button>
      <button type="button" class="btn" style="background:#3498db;color:#fff;" onclick="downloadCalendar()">Download Image</button>
      <input type="hidden" id="captureWidth" value="2200">
      <button type="button" class="btn" style="background:#e74c3c;color:#fff;" onclick="resetSettings()">Reset Defaults</button>
    </div>

    <div id="calendar-scale-wrapper">
      <div id="calendar" class="calendar-grid"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const LS_KEYS = { year:'sc_year', on:'sc_daysOn', off:'sc_daysOff', start:'sc_start', style:'sc_style', work:'sc_workColor', travel:'sc_travelColor', dark:'sc_darkMode', name:'sc_name', tint:'sc_tint', capture:'sc_capture', controls:'sc_controls_collapsed' };

    function saveSettings(){ try{ localStorage.setItem(LS_KEYS.year, yearSelect.value); localStorage.setItem(LS_KEYS.on, daysOn.value); localStorage.setItem(LS_KEYS.off, daysOff.value); localStorage.setItem(LS_KEYS.start, startDate.value); localStorage.setItem(LS_KEYS.style, layoutStyle.value); localStorage.setItem(LS_KEYS.work, workColor.value); localStorage.setItem(LS_KEYS.travel, travelColor.value); localStorage.setItem(LS_KEYS.tint, tintStrength.value); if(captureWidth) localStorage.setItem(LS_KEYS.capture, captureWidth.value); localStorage.setItem(LS_KEYS.dark, document.body.classList.contains('dark-mode') ? '1':'0'); if(nameField) localStorage.setItem(LS_KEYS.name, nameField.value.trim()); }catch(e){} }
    function loadSettings(){ try{ const setIf=(el,key)=>{ const v=localStorage.getItem(key); if(v && el) el.value=v; }; setIf(yearSelect,LS_KEYS.year); setIf(daysOn,LS_KEYS.on); setIf(daysOff,LS_KEYS.off); setIf(startDate,LS_KEYS.start); setIf(layoutStyle,LS_KEYS.style); setIf(workColor,LS_KEYS.work); setIf(travelColor,LS_KEYS.travel); setIf(nameField,LS_KEYS.name); setIf(tintStrength,LS_KEYS.tint); const cap=localStorage.getItem(LS_KEYS.capture); if(cap) captureWidth.value=cap; if(localStorage.getItem(LS_KEYS.dark)==='1') document.body.classList.add('dark-mode'); }catch(e){} }

    function __hexToRGBA(hex, alpha) { try { const h=(hex||'#000').replace('#',''); const n=parseInt(h,16); const r=(n>>16)&255, g=(n>>8)&255, b=n&255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; } catch(e){ return `rgba(0,0,0,${alpha||1})`; } }

    function updateColors(){ const onHex=workColor?.value||'#3498db'; const trHex=travelColor?.value||'#e67e22'; const basePct=parseInt(tintStrength?.value||'16',10); const clamp=(v,min,max)=>Math.max(min,Math.min(max,v)); const softOnPct=clamp(basePct-4,5,40); const softTrPct=clamp(basePct-2,5,40); const strongOnPct=clamp(basePct,5,40); const strongTrPct=clamp(basePct+2,5,40); document.documentElement.style.setProperty('--on-color',onHex); document.documentElement.style.setProperty('--travel-color',trHex); document.documentElement.style.setProperty('--on-tint-soft', __hexToRGBA(onHex, softOnPct/100)); document.documentElement.style.setProperty('--travel-tint-soft', __hexToRGBA(trHex, softTrPct/100)); document.documentElement.style.setProperty('--on-tint-strong', __hexToRGBA(onHex, strongOnPct/100)); document.documentElement.style.setProperty('--travel-tint-strong', __hexToRGBA(trHex, strongTrPct/100)); }

    function handleNameInput(){ updateNameInline(); saveSettings(); }
    function updateNameInline(){ const val=(nameField.value||'').trim(); const wrap=nameInline; const text=nameInlineText; if(val){ text.textContent=val; wrap.style.display='inline-flex'; } else { text.textContent=''; wrap.style.display='none'; } }

    function resetSettings(){ if(!confirm('Reset all settings to defaults?')) return; try{ Object.values(LS_KEYS).forEach(k=>localStorage.removeItem(k)); }catch(e){} yearSelect.value=new Date().getFullYear(); daysOn.value=21; daysOff.value=21; startDate.value='2026-01-08'; layoutStyle.value='layout-wall theme-wall'; workColor.value='#3498db'; travelColor.value='#e67e22'; tintStrength.value='16'; captureWidth.value='2200'; nameField.value=''; document.body.classList.remove('dark-mode'); updateColors(); updateNameInline(); generateCalendar(); }

    let currentScale=1; function applyAutoScale(){ const w=calendarScaleWrapper, c=calendar; if(!w||!c) return; const DESIGN_WIDTH=1600; const ww=w.clientWidth||window.innerWidth; const s=Math.min(1, ww/ DESIGN_WIDTH); if(Math.abs(s-currentScale)>.005){ currentScale=s; w.style.transformOrigin='top center'; w.style.transform=`scale(${s})`; } }
    function initAutoScale(){ applyAutoScale(); if(window.ResizeObserver){ (new ResizeObserver(()=>applyAutoScale())).observe(calendarScaleWrapper); } else { window.addEventListener('resize',applyAutoScale); } }
    function toggleDarkMode(){ document.body.classList.toggle('dark-mode'); saveSettings(); }

    function getSelectedYear(){ const y=parseInt(yearSelect.value,10); return Number.isFinite(y)?y:(new Date()).getFullYear(); }
    function handleYearChange(){ generateCalendar(); saveSettings(); }

    function generateCalendar(){ const dOn=parseInt(daysOn.value,10)||21; const dOff=parseInt(daysOff.value,10)||21; const startInput=startDate.value||'2026-01-08'; const year=getSelectedYear(); const layoutClasses=layoutStyle.value; const startShift=new Date(startInput+'T00:00:00'); const today=new Date(); today.setHours(0,0,0,0); const container=calendar; container.className='calendar-grid '+layoutClasses; container.innerHTML=''; const cycle=dOn+dOff; for(let m=0;m<12;m++){ const monthDiv=document.createElement('div'); monthDiv.className='month'; const first=new Date(year,m,1); let html=`<h3>${first.toLocaleString('default',{month:'long'})}</h3>`; html+=`<div class=\"weekday-header\"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div><div class=\"days\">`; for(let i=0;i<first.getDay();i++) html+='<div class=\"day empty\"></div>'; const date=new Date(year,m,1); while(date.getMonth()===m){ const diff=Math.round((date.getTime()-startShift.getTime())/86400000); let pos=diff%cycle; if(pos<0) pos+=cycle; const type=(pos===0||pos===dOn)?'travel-day': (pos>0&&pos<dOn)?'on-shift':'off-day'; const isToday=(date.getTime()===today.getTime())?'today':''; html+=`<div class=\"day ${type} ${isToday}\">${date.getDate()}</div>`; date.setDate(date.getDate()+1); } monthDiv.innerHTML=html+'</div>'; container.appendChild(monthDiv);} saveSettings(); requestAnimationFrame(applyAutoScale); }

    function buildCloneForCapture(){ const liveRoot=document.getElementById('calendar-capture-root'); const cloneRoot=liveRoot.cloneNode(true); cloneRoot.classList.add('pdf-mode'); cloneRoot.querySelectorAll('.controls, .mini-toolbar, .controls-toggle').forEach(el=>el.remove()); cloneRoot.querySelectorAll('.name-chip .label').forEach(el=>el.remove()); const chip=cloneRoot.querySelector('.name-chip'); if(chip){ chip.style.background='transparent'; chip.style.color='#000'; chip.style.boxShadow='none'; chip.style.padding='0'; } const wrap=cloneRoot.querySelector('#calendar-scale-wrapper'); if(wrap){ wrap.style.transform='none'; wrap.style.width='100%'; } const cal=cloneRoot.querySelector('#calendar'); if(cal){ cal.style.display='grid'; cal.style.gridTemplateColumns='repeat(3, 1fr)'; cal.style.gap='8px'; cal.style.margin='0 auto'; cal.style.width='100%'; cal.style.maxWidth='100%'; } return { cloneRoot }; }

    async function downloadCalendar(){ const year=getSelectedYear(); const { cloneRoot }=buildCloneForCapture(); const host=document.createElement('div'); host.style.position='fixed'; host.style.left='-99999px'; host.style.top='0'; host.style.zIndex='-1'; host.style.background='#ffffff'; host.appendChild(cloneRoot); document.body.appendChild(host); try{ const captureCssW=Math.max(800, parseInt(document.getElementById('captureWidth')?.value || '2200',10)); cloneRoot.style.width=captureCssW+'px'; cloneRoot.style.maxWidth=captureCssW+'px'; await new Promise(r=>requestAnimationFrame(r)); const fullH=Math.ceil(cloneRoot.scrollHeight || cloneRoot.getBoundingClientRect().height); const canvas=await html2canvas(cloneRoot,{ backgroundColor:'#ffffff', useCORS:true, width:captureCssW, height:fullH, windowWidth:captureCssW, windowHeight:fullH, scrollX:0, scrollY:0, scale:2.0 }); const link=document.createElement('a'); link.download=`Shift-Calendar-${year}.png`; link.href=canvas.toDataURL('image/png'); document.body.appendChild(link); link.click(); link.remove(); }catch(err){ console.error('PNG export failed:',err); alert('Sorry, generating the image failed.'); } finally { document.body.removeChild(host); } }

    async function downloadCalendarPDF(){ const { jsPDF } = window.jspdf || {}; if(!jsPDF){ alert('PDF library is still loading.'); return; } const year=getSelectedYear(); const { cloneRoot }=buildCloneForCapture(); const CSS_PPI=96, TARGET_DPI=300; const PAGE_IN_W=8.5, PAGE_IN_H=11, MARGIN_IN=0.25; const contentCssW=Math.round((PAGE_IN_W-2*MARGIN_IN)*CSS_PPI), contentCssH=Math.round((PAGE_IN_H-2*MARGIN_IN)*CSS_PPI); const fitBox=document.createElement('div'); fitBox.style.position='fixed'; fitBox.style.left='-99999px'; fitBox.style.top='0'; fitBox.style.background='#fff'; fitBox.style.width=contentCssW+'px'; fitBox.style.minHeight=contentCssH+'px'; fitBox.style.overflow='hidden'; const inner=document.createElement('div'); inner.style.transformOrigin='top left'; inner.appendChild(cloneRoot); fitBox.appendChild(inner); document.body.appendChild(fitBox); cloneRoot.style.width=contentCssW+'px'; cloneRoot.style.maxWidth=contentCssW+'px'; await new Promise(r=>requestAnimationFrame(r)); const naturalH=Math.ceil(fitBox.scrollHeight||fitBox.getBoundingClientRect().height); const scale=Math.min(1, contentCssH/naturalH); inner.style.transform=`scale(${scale})`; const finalH=Math.max(1, Math.floor(naturalH*scale)); const canvas=await html2canvas(fitBox,{ backgroundColor:'#ffffff', useCORS:true, width:contentCssW, height:finalH, windowWidth:contentCssW, windowHeight:finalH, scrollX:0, scrollY:0, scale: TARGET_DPI / CSS_PPI }); const pageW=612, pageH=792, MARGIN_PT=72*MARGIN_IN; const maxW=pageW-2*MARGIN_PT; const pxToPt=px=>(px/96)*72; const imgWpt=pxToPt(canvas.width), imgHpt=pxToPt(canvas.height); const drawW=maxW, drawH=imgHpt*(drawW/imgWpt); const offX=(pageW-drawW)/2, offY=(pageH-drawH)/2; const pdf=new jsPDF({orientation:'p', unit:'pt', format:'letter', compress:false}); if(typeof pdf.setCompression==='function') pdf.setCompression(false); pdf.addImage(canvas.toDataURL('image/png'),'PNG', offX, offY, drawW, drawH); pdf.save(`Shift-Calendar-${year}.pdf`); document.body.removeChild(fitBox); }

    // --- Controls accordion (mobile) ---
    function setControlsCollapsed(collapsed){ const controls=document.querySelector('.controls'); const toggle=document.getElementById('controlsToggle'); if(!controls||!toggle) return; if(collapsed){ controls.classList.add('is-collapsed'); toggle.setAttribute('aria-expanded','false'); toggle.textContent='Show Controls'; try{ localStorage.setItem(LS_KEYS.controls,'1'); }catch(e){} } else { controls.classList.remove('is-collapsed'); toggle.setAttribute('aria-expanded','true'); toggle.textContent='Hide Controls'; try{ localStorage.setItem(LS_KEYS.controls,'0'); }catch(e){} } }

    // Init references
    document.title='North Slope Shift Calendar';
    const yearSelect=document.getElementById('yearSelect'); const daysOn=document.getElementById('daysOn'); const daysOff=document.getElementById('daysOff'); const startDate=document.getElementById('startDate'); const layoutStyle=document.getElementById('layoutStyle'); const workColor=document.getElementById('workColor'); const travelColor=document.getElementById('travelColor'); const tintStrength=document.getElementById('tintStrength'); const nameField=document.getElementById('nameField'); const captureWidth=document.getElementById('captureWidth'); const calendarScaleWrapper=document.getElementById('calendar-scale-wrapper'); const calendar=document.getElementById('calendar'); const nameInline=document.getElementById('nameInline'); const nameInlineText=document.getElementById('nameInlineText');

    loadSettings(); updateColors(); updateNameInline(); generateCalendar(); initAutoScale();

    // Setup controls toggle state
    (function(){ const toggle=document.getElementById('controlsToggle'); const stored=localStorage.getItem(LS_KEYS.controls); const preferCollapsed=(stored!==null)?(stored==='1'):window.matchMedia('(max-width:700px)').matches; setControlsCollapsed(preferCollapsed); if(toggle){ toggle.addEventListener('click', ()=>{ const collapsed=document.querySelector('.controls')?.classList.contains('is-collapsed'); setControlsCollapsed(!collapsed); }); } })();

    // Auto-collapse after Update on phones
    (function(){ const updateBtn=document.querySelector('.btn.btn-gen'); if(updateBtn){ updateBtn.addEventListener('click', ()=>{ if(window.matchMedia('(max-width:700px)').matches) setControlsCollapsed(true); }); } })();
  </script>
</body>
</html>