<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>North Slope Shift Calendar</title>

  <!-- Keep your existing icon + manifest links (working on GitHub Pages) -->
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">

  <style>
    :root {
      --on-color: #3498db;
      --travel-color: #e67e22;
      --off-color: #ffffff;
      --text-main: #333;
      --bg-body: #f0f2f5;
      --bg-card: #ffffff;
      --border-color: #eee;
    }
    body.dark-mode {
      --off-color: #2c3e50;
      --text-main: #ecf0f1;
      --bg-body: #1a1a1a;
      --bg-card: #2d2d2d;
      --border-color: #444;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      padding: 20px;
      background: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      transition: background 0.3s;
    }

    .header-container {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
    }
    .legend {
      display: flex; gap: 15px; background: var(--bg-card);
      padding: 10px 15px; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.85em; font-weight: 600; }
    .dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #ddd; }

    .controls {
      background: var(--bg-card); padding: 20px; border-radius: 12px;
      display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); align-items: flex-end;
    }
    .control-group { display: flex; flex-direction: column; gap: 4px; }
    label { font-weight: 600; font-size: 0.85em; color: var(--text-main); opacity: 0.8; }
    input, select {
      padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;
      width: 140px; background: var(--bg-card); color: var(--text-main);
    }

    .btn { padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
    .btn-gen  { background: #2ecc71; color: white; }
    .btn-dark { background: #34495e; color: white; }
    .btn-print{ background: #95a5a6; color: white; }

    .calendar-grid { display: grid; gap: 20px; }

    /* LAYOUTS */
    .layout-standard { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
    .layout-compact  { grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .layout-poster   { grid-template-columns: repeat(2, 1fr); gap: 24px; }

    /* BASE MONTH CARD */
    .month { background: var(--bg-card); border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 15px; }
    h3 { text-align: center; color: var(--on-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 0; }

    .weekday-header, .days { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
    .weekday-header { font-weight: bold; color: #999; font-size: 0.75em; margin-bottom: 8px; }
    .day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.85em; border: 1px solid transparent; }
    .on-shift   { background: var(--on-color) !important; color: white; font-weight: bold; }
    .travel-day { background: var(--travel-color) !important; color: white; font-weight: bold; }
    .off-day    { background: var(--off-color); color: var(--text-main); border-color: var(--border-color); }
    .today      { border: 2px solid #e74c3c !important; }
    .empty { visibility: hidden; }

    input[type="color"] { padding: 0; height: 38px; cursor: pointer; }

    /* ===== THEMES (VISUALS) ===== */

    /* 1) Classic Cards (rounded pills, soft shadows) */
    .theme-standard .month { border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,.08); }
    .theme-standard .day { border-radius: 50%; }

    /* 2) Dense Outline (tight, square cells, outlines) */
    .theme-outline .month { box-shadow: none; border: 1px solid var(--border-color); border-radius: 8px; }
    .theme-outline h3 { color: var(--text-main); background: rgba(0,0,0,0.03); border: none; padding: 10px; border-radius: 6px; }
    .theme-outline .day { border-radius: 4px; border: 1px solid var(--border-color); background: transparent; font-size: 0.8em; }
    .theme-outline .off-day { background: transparent; }
    .theme-outline .weekday-header { color: #777; }

    /* 3) Poster Board (bold gradient header, minimal day chrome) */
    .theme-poster .month {
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(52,152,219,.08), rgba(230,126,34,.08));
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      overflow: hidden;
    }
    .theme-poster h3 {
      color: white;
      margin: -15px -15px 12px -15px;
      padding: 14px 10px;
      background: linear-gradient(135deg, var(--on-color), var(--travel-color));
      border: none;
    }
    .theme-poster .weekday-header { color: #666; font-weight: 700; }
    .theme-poster .day { border-radius: 0; border: 1px dashed transparent; background: rgba(255,255,255,0.6); }
    .theme-poster .off-day { background: rgba(255,255,255,0.3); }
    .theme-poster .today { border-color: #e74c3c !important; }

    /* Print */
    @media print {
      .controls, .btn-print, .btn-dark { display: none !important; }
      body { background: white !important; color: black !important; padding: 0 !important; }
      .calendar-grid { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 5px !important; }
      .month { border: 1px solid #eee !important; box-shadow: none !important; page-break-inside: avoid; font-size: 0.8rem !important; }
    }
  </style>
</head>
<body>
  <div class="header-container">
    <h2 id="pageTitle">North Slope Shift Calendar</h2>
    <div class="legend">
      <div class="legend-item"><div class="dot" style="background: var(--on-color);"></div> Work</div>
      <div class="legend-item"><div class="dot" style="background: var(--travel-color);"></div> Travel</div>
      <div class="legend-item"><div class="dot" style="background: var(--off-color);"></div> Off</div>
    </div>
  </div>

  <div class="controls">
    <!-- Year selector -->
    <div class="control-group">
      <label for="yearSelect">Year</label>
      <input type="number" id="yearSelect" min="1970" max="2100" value="2026" oninput="handleYearChange()">
    </div>

    <div class="control-group"><label for="daysOn">Days ON</label><input type="number" id="daysOn" value="21"></div>
    <div class="control-group"><label for="daysOff">Days OFF</label><input type="number" id="daysOff" value="21"></div>
    <div class="control-group"><label for="startDate">1st Day ON</label><input type="date" id="startDate" value="2026-01-08"></div>

    <div class="control-group">
      <label for="layoutStyle">Style</label>
      <select id="layoutStyle" onchange="generateCalendar()">
        <option value="layout-standard theme-standard">Classic Cards</option>
        <option value="layout-compact theme-outline">Dense Outline</option>
        <option value="layout-poster theme-poster">Poster Board</option>
      </select>
    </div>

    <div class="control-group"><label for="workColor">Work</label><input type="color" id="workColor" value="#3498db" oninput="updateColors()" aria-label="Work color"></div>
    <div class="control-group"><label for="travelColor">Travel</label><input type="color" id="travelColor" value="#e67e22" oninput="updateColors" aria-label="Travel color"></div>

    <button type="button" class="btn btn-gen" onclick="generateCalendar()">Update</button>
    <button type="button" class="btn btn-dark" onclick="document.body.classList.toggle('dark-mode')">Dark Mode</button>

    <button type="button" class="btn btn-print" onclick="window.print()">Print PDF</button>
    <span style="font-size: 0.75em; opacity: 0.7; margin-left: 6px; color: var(--text-main);">
      *Enable "Background graphics" in print settings.
    </span>

    <button type="button" class="btn" style="background: #3498db; color: white;" onclick="downloadCalendar()">Download Image</button>
  </div>

  <div id="calendar" class="calendar-grid"></div>

  <!-- Load html2canvas BEFORE our inline script to ensure it's ready -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Color updates
    function updateColors() {
      document.documentElement.style.setProperty('--on-color', document.getElementById('workColor').value);
      document.documentElement.style.setProperty('--travel-color', document.getElementById('travelColor').value);
    }

    // Year handling
    function getSelectedYear() {
      const y = parseInt(document.getElementById('yearSelect').value, 10);
      return Number.isFinite(y) ? y : (new Date()).getFullYear();
    }
    function handleYearChange() { generateCalendar(); }

    // Calendar generation
    function generateCalendar() {
      const daysOn  = parseInt(document.getElementById('daysOn').value, 10)  || 21;
      const daysOff = parseInt(document.getElementById('daysOff').value, 10) || 21;
      const startInput = document.getElementById('startDate').value || "2026-01-08";
      const year = getSelectedYear();

      const layoutClasses = document.getElementById('layoutStyle').value; // layout + theme classes
      const startShift = new Date(startInput + "T00:00:00");

      const today = new Date(); today.setHours(0,0,0,0);
      const container = document.getElementById('calendar');
      container.className = 'calendar-grid ' + layoutClasses;
      container.innerHTML = '';

      const cycle = daysOn + daysOff;

      for (let m = 0; m < 12; m++) {
        const monthDiv = document.createElement('div');
        monthDiv.className = 'month';

        const first = new Date(year, m, 1);
        let html = `<h3>${first.toLocaleString('default', { month: 'long' })}</h3>`;
        html += `<div class=\"weekday-header\"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div><div class=\"days\">`;

        for (let i = 0; i < first.getDay(); i++) html += `<div class=\"day empty\"></div>`;

        const date = new Date(year, m, 1);
        while (date.getMonth() === m) {
          const diff = Math.round((date.getTime() - startShift.getTime()) / 86400000);
          let pos = diff % cycle;
          if (pos < 0) pos += cycle;

          const type = (pos === 0 || pos === daysOn) ? 'travel-day' : (pos > 0 && pos < daysOn) ? 'on-shift' : 'off-day';
          const isToday = (date.getTime() === today.getTime()) ? 'today' : '';

          html += `<div class=\"day ${type} ${isToday}\">${date.getDate()}</div>`;
          date.setDate(date.getDate() + 1);
        }

        monthDiv.innerHTML = html + `</div>`;
        container.appendChild(monthDiv);
      }
    }

    // Download image (with guards + full restore)
    function downloadCalendar() {
      const calendar = document.getElementById('calendar');
      const year = getSelectedYear();

      const original = {
        display: calendar.style.display,
        gridTemplateColumns: calendar.style.gridTemplateColumns,
        maxWidth: calendar.style.maxWidth
      };

      // Force 3x4 layout for the screenshot
      calendar.style.display = 'grid';
      calendar.style.gridTemplateColumns = 'repeat(3, 1fr)';
      calendar.style.maxWidth = '1200px';

      if (!window.html2canvas) {
        alert('Download library is still loading. Please wait a moment and try again.');
        // Restore original
        calendar.style.display = original.display;
        calendar.style.gridTemplateColumns = original.gridTemplateColumns;
        calendar.style.maxWidth = original.maxWidth;
        return;
      }

      const bg = document.body.classList.contains('dark-mode') ? '#1a1a1a' : '#ffffff';

      try {
        window.html2canvas(calendar, { scale: 2, useCORS: true, backgroundColor: bg })
          .then(canvas => {
            const link = document.createElement('a');
            link.download = `Shift-Calendar-${year}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
          })
          .catch(err => {
            console.error('html2canvas failed:', err);
            alert('Sorry, generating the image failed. See the console for details.');
          })
          .finally(() => {
            // Restore original layout
            calendar.style.display = original.display;
            calendar.style.gridTemplateColumns = original.gridTemplateColumns;
            calendar.style.maxWidth = original.maxWidth;
          });
      } catch (e) {
        console.error('Download error:', e);
        alert('Unexpected error while preparing the image.');
        // Restore just in case
        calendar.style.display = original.display;
        calendar.style.gridTemplateColumns = original.gridTemplateColumns;
        calendar.style.maxWidth = original.maxWidth;
      }
    }

    // Minimal Option B: set static titles once (no dynamic year)
    document.title = 'North Slope Shift Calendar';
    (function(){
      const h = document.getElementById('pageTitle');
      if (h) h.textContent = 'North Slope Shift Calendar';
    })();

    // Initial render
    generateCalendar();
  </script>
</body>
</html>
